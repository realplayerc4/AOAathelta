# æœºå™¨äººä½ç½®æ›´æ–°é¢‘ç‡æ”¹è¿› - å®ç°æ€»ç»“

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

1. **é™ä½æœºå™¨äººä½ç½®æ›´æ–°é¢‘ç‡**ï¼šä» 20Hz (0.05sé—´éš”) æ”¹ä¸º 10Hz (0.1sé—´éš”)
2. **é›†æˆæ»¤æ³¢åçš„Beaconæ•°æ®**ï¼šæ¯æ¬¡æœºå™¨äººä½ç½®æ›´æ–°æ—¶ï¼ŒåŒæ—¶è·å–ç”± `workers/aoa_kalman_filter.py` ä¸­çš„å¡å°”æ›¼æ»¤æ³¢å™¨è®¡ç®—å‡ºçš„æ»¤æ³¢åä½ç½®æ•°æ®

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. é…ç½®æ–‡ä»¶ä¿®æ”¹ - [config.py](config.py)

**æ›´æ”¹å‰ï¼š**
```python
POSE_QUERY_INTERVAL = 0.05  # 20Hz
```

**æ›´æ”¹åï¼š**
```python
POSE_QUERY_INTERVAL = 0.1  # 10Hz
```

**å½±å“èŒƒå›´**ï¼šæ§åˆ¶æœºå™¨äººä½ç½®æŸ¥è¯¢çš„é¢‘ç‡

---

### 2. åå°æ›´æ–°çº¿ç¨‹ - [web_app.py](web_app.py#L107-L170)

#### å‡½æ•°ï¼š`update_position_worker()`

**å…³é”®æ”¹è¿›ï¼š**

1. **å¯¼å…¥é…ç½®æ–‡ä»¶**
   ```python
   import config
   ```
   ä½¿ç”¨åŠ¨æ€é…ç½®çš„ `POSE_QUERY_INTERVAL`

2. **æ›´æ–°çº¿ç¨‹å»¶è¿Ÿ**
   ```python
   time.sleep(config.POSE_QUERY_INTERVAL)  # ä½¿ç”¨10Hzé—´éš”è€Œéç¡¬ç¼–ç 0.1
   ```

3. **é›†æˆæ»¤æ³¢åçš„Beaconåæ ‡**
   ```python
   # è·å–æ»¤æ³¢åçš„beaconåæ ‡
   filtered_beacon = kalman.get_filtered_beacon_coordinates(tag_id=1)
   
   with position_lock:
       position_cache['robot_pose'] = robot_pose
       position_cache['filtered_beacon'] = filtered_beacon  # æ–°å¢
       position_cache['timestamp'] = time.time()
       logger.debug(f"ğŸ¤– æœºå™¨äººä½ç½®: ({robot_pose.get('x', 0):.2f}, {robot_pose.get('y', 0):.2f}), "
                  f"ğŸ”¦ æ»¤æ³¢beacon: ({filtered_beacon.get('x', 0):.2f}, {filtered_beacon.get('y', 0):.2f})")
   ```

**å·¥ä½œæµç¨‹ï¼š**
```
[10Hz å®šæ—¶å™¨]
    â†“
[è·å–æœºå™¨äººä½ç½® - robot_pose]
    â†“
[è·å–æ»¤æ³¢åBeaconåæ ‡ - filtered_beacon]
    â†“
[å­˜å‚¨åˆ°position_cache]
    â†“
[APIç«¯ç‚¹è¯»å–ç¼“å­˜]
```

---

### 3. APIç«¯ç‚¹æ›´æ–° - [web_app.py](web_app.py#L275-L305)

#### ç«¯ç‚¹ï¼š`/api/robot-pose` (GET)

**åŸåŠŸèƒ½ï¼š** ä»…è¿”å›æœºå™¨äººä½å§¿æ€

**æ–°åŠŸèƒ½ï¼š** è¿”å›æœºå™¨äººä½å§¿æ€ + æ»¤æ³¢åçš„Beaconåæ ‡

**å“åº”æ ¼å¼å¯¹æ¯”ï¼š**

**æ›´æ”¹å‰ï¼š**
```json
{
  "x": 0.40,
  "y": -1.40,
  "yaw": -2.06,
  "z": 0.0,
  "pitch": 0.0,
  "roll": 0.0
}
```

**æ›´æ”¹åï¼š**
```json
{
  "x": 0.40,
  "y": -1.40,
  "yaw": -2.06,
  "z": 0.0,
  "pitch": 0.0,
  "roll": 0.0,
  "filtered_beacon": {
    "x": 1.23,
    "y": 2.45,
    "confidence": 0.85,
    "velocity_x": 0.10,
    "velocity_y": -0.05
  }
}
```

**æ–°å¢å­—æ®µè¯´æ˜ï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `filtered_beacon.x` | float | å¡å°”æ›¼æ»¤æ³¢åçš„Beacon Xåæ ‡ï¼ˆç±³ï¼‰ |
| `filtered_beacon.y` | float | å¡å°”æ›¼æ»¤æ³¢åçš„Beacon Yåæ ‡ï¼ˆç±³ï¼‰ |
| `filtered_beacon.confidence` | float | æ»¤æ³¢ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰ |
| `filtered_beacon.velocity_x` | float | Xæ–¹å‘é€Ÿåº¦ï¼ˆç±³/ç§’ï¼‰ |
| `filtered_beacon.velocity_y` | float | Yæ–¹å‘é€Ÿåº¦ï¼ˆç±³/ç§’ï¼‰ |

---

## ğŸ“Š æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          update_position_worker()            â”‚  (10Hzå®šæ—¶)
â”‚          (æ¯100msæ‰§è¡Œä¸€æ¬¡)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                     â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ APIè·å–     â”‚      â”‚ Kalmanè·å–           â”‚
   â”‚ æœºå™¨äººä½ç½®  â”‚      â”‚ æ»¤æ³¢Beaconåæ ‡      â”‚
   â”‚ robot_pose  â”‚      â”‚ filtered_beacon      â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ position_cache       â”‚
            â”‚ (çº¿ç¨‹å®‰å…¨ç¼“å­˜)       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ /api/robot-pose      â”‚
            â”‚ (HTTP GETè¯·æ±‚)       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ å‰ç«¯JavaScript       â”‚
            â”‚ æ˜¾ç¤ºæœºå™¨äººå’ŒBeacon   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ é¢‘ç‡å¯¹æ¯”

### æ›´æ–°é¢‘ç‡å˜åŒ–

| æŒ‡æ ‡ | æ›´æ”¹å‰ | æ›´æ”¹å | å˜åŒ– |
|------|--------|--------|------|
| **ä½ç½®æŸ¥è¯¢é—´éš”** | 50ms | 100ms | â†“ |
| **ä½ç½®æŸ¥è¯¢é¢‘ç‡** | 20Hz | 10Hz | â†“ |
| **æ•°æ®ç‚¹/ç§’** | 20 | 10 | â†“ 50% |
| **ç³»ç»Ÿè´Ÿè½½** | é«˜ | ä½ | â†“ |
| **ç½‘ç»œæµé‡** | é«˜ | ä½ | â†“ |

### ä¼˜åŠ¿

- âœ… é™ä½ç³»ç»ŸCPUå ç”¨
- âœ… å‡å°‘ç½‘ç»œå¸¦å®½æ¶ˆè€—  
- âœ… ä¿è¯æ•°æ®è´¨é‡ï¼ˆæ»¤æ³¢æ•ˆæœæ›´ç¨³å®šï¼‰
- âœ… é™ä½åŠŸè€—ï¼ˆç‰¹åˆ«å¯¹ç§»åŠ¨è®¾å¤‡æœ‰åˆ©ï¼‰

### æƒè¡¡

- âš  ä½ç½®æ›´æ–°å»¶è¿Ÿå¢åŠ 50msï¼ˆä»50msâ†’100msï¼‰
- âš  å®æ—¶æ€§ç•¥é™ä½ï¼ˆä½†10Hzå¯¹å¤§å¤šæ•°åº”ç”¨ä»å……åˆ†ï¼‰

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### æµ‹è¯•APIå“åº”

```bash
# 1. å¯åŠ¨ç³»ç»Ÿ
curl -X POST http://127.0.0.1:5000/api/start \
  -H "Content-Type: application/json" \
  -d '{"port": "/dev/ttyUSB0"}'

# 2. æŸ¥è¯¢æœºå™¨äººä½ç½® + æ»¤æ³¢Beacon
curl http://127.0.0.1:5000/api/robot-pose | jq .

# è¾“å‡ºç¤ºä¾‹ï¼š
# {
#   "x": 0.40,
#   "y": -1.40,
#   "yaw": -2.06,
#   "filtered_beacon": {
#     "x": 1.23,
#     "y": 2.45,
#     "confidence": 0.85,
#     "velocity_x": 0.10,
#     "velocity_y": -0.05
#   }
# }
```

### Pythonæµ‹è¯•è„šæœ¬

```python
import requests
import time

# å¤šæ¬¡æŸ¥è¯¢æµ‹è¯•æ›´æ–°é¢‘ç‡
timestamps = []
for i in range(10):
    response = requests.get('http://127.0.0.1:5000/api/robot-pose')
    timestamps.append(time.time())
    time.sleep(0.1)

# è®¡ç®—é¢‘ç‡
intervals = [timestamps[i+1] - timestamps[i] for i in range(len(timestamps)-1)]
avg_freq = 1 / (sum(intervals) / len(intervals))
print(f"å¹³å‡æ›´æ–°é¢‘ç‡: {avg_freq:.1f}Hz")  # åº”ä¸º ~10Hz
```

---

## ğŸ“ ä»£ç ä½ç½®æ˜ å°„

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| é…ç½®æ›´æ–°é¢‘ç‡ | [config.py](config.py) | 33 |
| åå°æ›´æ–°çº¿ç¨‹ | [web_app.py](web_app.py) | 107-170 |
| é›†æˆæ»¤æ³¢Beacon | [web_app.py](web_app.py) | 152-159 |
| APIç«¯ç‚¹ | [web_app.py](web_app.py) | 275-305 |
| Beaconè·å–æ–¹æ³• | [workers/aoa_kalman_filter.py](workers/aoa_kalman_filter.py) | 1165-1198 |

---

## âœ… ä¿®æ”¹æ£€æŸ¥æ¸…å•

- [x] âœ“ config.py: POSE_QUERY_INTERVAL æ”¹ä¸º 0.1 (10Hz)
- [x] âœ“ web_app.py: update_position_worker() ä½¿ç”¨åŠ¨æ€é…ç½®
- [x] âœ“ web_app.py: é›†æˆ kalman.get_filtered_beacon_coordinates()
- [x] âœ“ web_app.py: position_cache æ·»åŠ  'filtered_beacon' å­—æ®µ
- [x] âœ“ web_app.py: /api/robot-pose è¿”å› filtered_beacon æ•°æ®
- [x] âœ“ è¯­æ³•æ£€æŸ¥é€šè¿‡
- [x] âœ“ æ—¥å¿—è¾“å‡ºåŒ…å«é¢‘ç‡å’Œæ•°æ®ä¿¡æ¯

---

## ğŸš€ åç»­å¯é€‰æ”¹è¿›

1. **å¯é…ç½®çš„Beacon Tag ID**
   - å½“å‰ç¡¬ç¼–ç  `tag_id=1`
   - å¯ä¿®æ”¹ä¸ºä»è¯·æ±‚å‚æ•°è¯»å–

2. **å¤šç›®æ ‡è·Ÿè¸ª**
   - æ”¯æŒåŒæ—¶è¿”å›å¤šä¸ªBeaconçš„æ»¤æ³¢æ•°æ®

3. **è‡ªé€‚åº”é¢‘ç‡**
   - æ ¹æ®æ•°æ®è´¨é‡è‡ªåŠ¨è°ƒæ•´æ›´æ–°é¢‘ç‡
   - æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒèŠ‚

4. **æ€§èƒ½ç›‘æµ‹**
   - æ·»åŠ æ€§èƒ½æŒ‡æ ‡ç«¯ç‚¹ `/api/metrics`
   - è¿”å›CPUå ç”¨ã€æ›´æ–°å»¶è¿Ÿç­‰æŒ‡æ ‡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [config.py](config.py) - ç³»ç»Ÿé…ç½®
- [web_app.py](web_app.py) - Flaskä¸»åº”ç”¨
- [workers/aoa_kalman_filter.py](workers/aoa_kalman_filter.py) - å¡å°”æ›¼æ»¤æ³¢å™¨
- [static/js/map.js](static/js/map.js) - å‰ç«¯æ•°æ®å±•ç¤º

