# 追踪位置功能 - 与主应用集成指南

## 快速集成

### 1. 在主窗口中使用

修改 `ui/main_window.py`：

```python
from ui.widgets.map_viewer import MapViewerDialog

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        # ... 其他初始化代码 ...
        
        # 创建地图查看器
        self.map_viewer = MapViewerDialog(self)
        
        # 订阅地图话题
        self.ws_subscriber.subscribe_topic(
            "/map",
            self._on_map_received
        )
        
        # 订阅追踪位置话题 (新增)
        self.ws_subscriber.subscribe_topic(
            "/tracked_pose",
            self._on_tracked_pose_received
        )
    
    def _on_map_received(self, payload):
        """处理地图数据"""
        try:
            map_data = json.loads(payload)
            self.map_viewer.update_map(map_data)
        except Exception as e:
            logger.error(f"处理地图数据失败: {e}")
    
    def _on_tracked_pose_received(self, payload):
        """处理追踪位置数据 (新增)"""
        try:
            message = json.loads(payload)
            
            # 提取位置和朝向
            pose_data = {
                "pos": [message["pos"]["x"], message["pos"]["y"]],
                "ori": message["ori"]
            }
            
            # 更新地图
            self.map_viewer.update_tracked_pose(pose_data)
        except Exception as e:
            logger.error(f"处理追踪位置失败: {e}")
```

### 2. 消息格式适配

如果 `/tracked_pose` 话题的消息格式不同，需要修改解析逻辑：

```python
# 示例 1: 如果消息格式为 ROS 的 PoseStamped
message = {
    "header": {...},
    "pose": {
        "position": {"x": 0.5, "y": 1.2, "z": 0},
        "orientation": {"x": 0, "y": 0, "z": 0.707, "w": 0.707}
    }
}

# 转换为：
from tf_transformations import euler_from_quaternion

pose_data = {
    "pos": [message["pose"]["position"]["x"], 
            message["pose"]["position"]["y"]],
    "ori": euler_from_quaternion([
        message["pose"]["orientation"]["x"],
        message["pose"]["orientation"]["y"],
        message["pose"]["orientation"]["z"],
        message["pose"]["orientation"]["w"]
    ])[2]  # 获取yaw角
}

# 示例 2: 如果消息格式为简单的JSON
message = {
    "x": 0.5,
    "y": 1.2,
    "theta": 0.785  # 弧度
}

# 转换为：
pose_data = {
    "pos": [message["x"], message["y"]],
    "ori": message["theta"]
}
```

### 3. 错误处理

```python
def _on_tracked_pose_received(self, payload):
    """处理追踪位置数据，包含错误处理"""
    try:
        message = json.loads(payload)
        
        # 验证必要字段
        if not isinstance(message, dict):
            logger.warning("追踪位置数据格式错误")
            return
        
        # 提取位置
        if "pos" in message:
            pos = message["pos"]
            if isinstance(pos, list) and len(pos) >= 2:
                x, y = pos[0], pos[1]
            elif isinstance(pos, dict) and "x" in pos and "y" in pos:
                x, y = pos["x"], pos["y"]
            else:
                logger.warning("位置数据格式不符")
                return
        else:
            logger.warning("缺少位置数据")
            return
        
        # 提取朝向
        if "ori" in message:
            ori = message["ori"]
            if not isinstance(ori, (int, float)):
                logger.warning("朝向数据类型错误")
                return
        else:
            logger.warning("缺少朝向数据")
            return
        
        # 更新地图
        pose_data = {"pos": [x, y], "ori": ori}
        self.map_viewer.update_tracked_pose(pose_data)
        
    except json.JSONDecodeError as e:
        logger.error(f"解析JSON失败: {e}")
    except Exception as e:
        logger.error(f"处理追踪位置失败: {e}")
```

## API 参考

### MapViewerDialog 新增方法

#### `update_tracked_pose(pose_data: dict)`

更新追踪位置并自动刷新地图。

**参数：**
- `pose_data` (dict): 包含位置和朝向的字典
  - `pos` (list): `[x, y]` 位置坐标（米）
  - `ori` (float): 朝向角度（弧度）

**示例：**
```python
pose_data = {
    "pos": [0.5, 1.2],
    "ori": 0.785
}
viewer.update_tracked_pose(pose_data)
```

**备注：**
- 自动触发地图刷新
- 位置超出范围时自动跳过绘制
- 缺少字段时优雅处理

### 内部方法

#### `_mark_tracked_pose_on_image(pixmap, map_data, pose_data)`

在图像上绘制追踪位置标记。

**参数：**
- `pixmap` (QPixmap): 原始图像
- `map_data` (dict): 地图配置
- `pose_data` (dict): 追踪位置数据

**返回：**
- (QPixmap): 标注后的图像

## 常见问题

### Q: 如何处理多个追踪目标？

A: 当前实现支持单个追踪对象。如需多对象支持，可以修改：

```python
# 修改存储为列表
self.tracked_poses = []

# 添加新方法
def add_tracked_pose(self, name, pose_data):
    self.tracked_poses.append({
        "name": name,
        "pose": pose_data
    })

# 在绘制时遍历所有对象
for tracked in self.tracked_poses:
    pixmap = self._mark_tracked_pose_on_image(
        pixmap, 
        self.current_map_data, 
        tracked["pose"]
    )
```

### Q: 如何自定义箭头样式？

A: 修改 `_mark_tracked_pose_on_image()` 方法中的参数：

```python
# 修改箭头颜色
blue_color = QColor(0, 200, 255)  # 更亮的蓝色

# 修改圆点大小
radius = 6  # 更大的点

# 修改箭头长度
arrow_length = 20  # 更长的箭头

# 修改箭头头部大小
arrow_size = 7  # 更大的箭头头部
```

### Q: 如何禁用追踪位置显示？

A: 简单地不调用 `update_tracked_pose()`：

```python
# 只更新地图，不显示追踪位置
self.map_viewer.update_map(map_data)
```

或清除追踪位置：

```python
self.map_viewer.tracked_pose = None
self.map_viewer._refresh_map()
```

### Q: 朝向角度如何转换？

A: 支持弧度和度数的转换：

```python
import math

# 度数转弧度
ori_rad = math.radians(45)  # 45° → π/4

# 弧度转度数
ori_deg = math.degrees(0.785)  # 0.785 rad → 45°
```

## 测试清单

集成前的检查：

- [ ] 地图数据正常显示（绿色原点可见）
- [ ] `/tracked_pose` 话题订阅成功
- [ ] 追踪位置更新频率合理（> 1Hz）
- [ ] 位置坐标转换正确
- [ ] 箭头朝向正确指示机器人方向
- [ ] 位置超出范围时优雅处理
- [ ] 无内存泄漏（长时间运行）
- [ ] UI响应流畅（无卡顿）

## 性能优化建议

如果遇到性能问题：

1. **降低更新频率**
   ```python
   # 不是每次都更新，而是间隔更新
   if self.frame_count % 10 == 0:  # 每10帧更新一次
       self.map_viewer.update_tracked_pose(pose_data)
   ```

2. **缓存计算结果**
   ```python
   # 避免重复计算像素坐标
   self.cached_pixel_x = ...
   self.cached_pixel_y = ...
   ```

3. **使用较小的地图分辨率**
   ```python
   # 如果地图太大，缩小一些
   map_data["resolution"] = 0.2  # 从 0.1 改为 0.2
   ```

## 故障排查

### 箭头不显示

检查清单：
- [ ] 追踪位置在地图范围内？
- [ ] pose_data 包含 "pos" 和 "ori"？
- [ ] 位置坐标单位正确（米）？
- [ ] 朝向单位正确（弧度）？

调试方法：
```python
# 添加日志
print(f"追踪位置: {pose_data}")
print(f"地图范围: {map_data['size']}")
print(f"地图原点: {map_data['origin']}")
print(f"分辨率: {map_data['resolution']}")

# 手动计算像素坐标
pixel_x = (pose_data["pos"][0] - map_data["origin"][0]) / map_data["resolution"]
pixel_y = map_data["size"][1] - ((pose_data["pos"][1] - map_data["origin"][1]) / map_data["resolution"])
print(f"像素坐标: ({pixel_x}, {pixel_y})")
```

### 箭头位置错误

可能原因和解决方案：
1. **坐标系不匹配** - 检查原点定义
2. **分辨率设置错误** - 验证 resolution 值
3. **Y轴反向处理** - 检查像素坐标计算

### 性能下降

检查：
- [ ] 地图更新频率是否过高？
- [ ] 是否有内存泄漏？
- [ ] 图像分辨率是否过大？

## 总结

追踪位置功能已完全集成到地图查看器中，可直接在主应用中使用。只需：

1. 订阅 `/tracked_pose` 话题
2. 解析消息格式
3. 调用 `update_tracked_pose()` 方法

整个过程仅需几行代码！
