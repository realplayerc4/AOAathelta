# 实时地图原点标注功能说明

## 功能描述

在实时地图PNG图像上自动标注坐标原点 [0, 0]，以绿色小点和十字标记显示。

## 实现原理

### 坐标系统

- **地图原点 (origin)**：代表PNG图片**左下角**的距离坐标（以米为单位）
- **PNG坐标系**：从左上角 (0, 0) 开始
- **地图坐标系**：通常从左下角开始的物理世界坐标

### 计算公式

给定：
- `origin = [x0, y0]`：左下角的距离坐标（米）
- `resolution`：每像素的距离（米/像素）
- `size = [width, height]`：图片尺寸（像素）

要找实际坐标 (0, 0) 在PNG中的像素位置：

```
origin_x_pixel = -origin[0] / resolution
origin_y_pixel_from_bottom = -origin[1] / resolution
origin_y_pixel_from_top = size[1] - origin_y_pixel_from_bottom
```

### 例子

```
origin = [-8.1, -4.8] 米
resolution = 0.1 米/像素
size = [182, 59] 像素

计算：
origin_x_pixel = -(-8.1) / 0.1 = 81.0 像素
origin_y_pixel_from_bottom = -(-4.8) / 0.1 = 48.0 像素
origin_y_pixel_from_top = 59 - 48.0 = 11.0 像素

结果：坐标 [0, 0] 位于图片的像素位置 (81, 11)
```

## 可视化标记

在计算出的像素位置使用以下标记：

1. **绿色圆点**：半径 5 像素的实心圆
2. **绿色十字**：长度 10 像素的水平和竖直线

颜色：纯绿色 RGB(0, 255, 0)

## 修改的文件

### 1. `ui/widgets/map_viewer.py`

#### 变更 1：导入新的绘图类
```python
# 添加了 QPainter, QColor, QPen, QBrush
from PyQt6.QtGui import QPixmap, QImage, QPainter, QColor, QPen, QBrush
```

#### 变更 2：添加原点标注方法
```python
def _mark_origin_on_image(self, pixmap: QPixmap, map_data: dict) -> QPixmap:
    """
    在图像上标注坐标原点 [0, 0]
    """
```

#### 变更 3：在 `_refresh_map()` 中调用标注
```python
# 在图像上标注坐标原点
pixmap = self._mark_origin_on_image(pixmap, self.current_map_data)
```

### 2. `test_map_viewer.py`

更新测试数据说明，确保原点设置合理使得 [0, 0] 在图片范围内。

## 测试方法

### 方式 1：使用测试脚本

```bash
python test_origin_mark.py
```

输出：
```
地图数据:
  原点 (origin): [-8.1, -4.8]
  分辨率 (resolution): 0.1 m/pixel
  尺寸 (size): [182, 59]

计算结果:
  原点像素位置 (X): 81.0 px
  原点像素位置 (Y from bottom): 48.0 px
  原点像素位置 (Y from top): 11.0 px
  图像范围: X=[0, 182), Y=[0, 59)
✓ 原点在图像范围内，进行标注

✓ 标注后的地图已保存到: /tmp/map_with_origin.png
```

生成的图像保存在 `/tmp/map_with_origin.png`

### 方式 2：运行主应用

```bash
python main.py
```

启动主窗口后，接收到地图数据时将自动标注原点。

## 特殊情况处理

### 原点超出图像范围

如果计算得出的原点像素位置超出图像范围，标注不会进行：

```python
if (0 <= origin_x_pixel < size[0] and 0 <= origin_y_pixel < size[1]):
    # 进行标注
```

此时图像正常显示，但不会有绿色标记。

## 性能考虑

- 标注操作只在需要刷新地图时执行
- 使用 QPixmap 的副本进行绘制，不影响原始数据
- 绘制操作使用 QPainter，效率高

## 日志和调试

`test_origin_mark.py` 中的 `mark_origin_on_image()` 函数会打印：

- 地图数据（原点、分辨率、尺寸）
- 计算过程（各个坐标值）
- 判断结果（是否在范围内）

这有助于调试坐标变换问题。
