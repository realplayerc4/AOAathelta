# 实时地图坐标原点标注 - 快速参考

## 快速开始

### 1. 查看实现代码
地图查看器中的原点标注实现：
```bash
cat ui/widgets/map_viewer.py | grep -A 50 "_mark_origin_on_image"
```

### 2. 运行测试
```bash
# 基础测试
python test_origin_mark.py

# 集成测试（多个场景）
python test_origin_marking_integration.py

# 主应用
python main.py
```

## 核心算法

### 问题
给定物理世界坐标系中的地图，标注逻辑坐标 [0, 0] 的位置。

### 输入
- `origin`: [x0, y0] - 图片左下角的物理坐标（米）
- `resolution`: res - 每像素对应的物理距离（米/像素）
- `size`: [w, h] - 图片尺寸（像素）

### 输出
- (x_pixel, y_pixel) - 坐标 [0, 0] 在PNG中的像素位置

### 算法
```
x_pixel = -x0 / res
y_pixel = h - (-y0 / res)
```

### 验证
```python
if 0 <= x_pixel < w and 0 <= y_pixel < h:
    # 原点在范围内，进行标注
    draw_green_mark(x_pixel, y_pixel)
```

## 文件清单

| 文件 | 说明 |
|------|------|
| `ui/widgets/map_viewer.py` | **【核心】** 地图查看器，包含原点标注逻辑 |
| `test_origin_mark.py` | 基础功能测试 |
| `test_origin_marking_integration.py` | 多场景集成测试 |
| `test_map_viewer.py` | 地图查看器UI测试 |
| `原点标注功能说明.md` | 功能详细说明 |
| `实现总结.md` | 实现概览和总结 |
| 本文件 | 快速参考 |

## 示例数据

### 标准配置（推荐）
```python
map_data = {
    "topic": "/map",
    "resolution": 0.1,        # 10厘米/像素
    "size": [182, 59],        # 182x59像素
    "origin": [-8.1, -4.8],   # 左下角距离原点 8.1m左, 4.8m下
    "data": "base64_png_data"
}

# 结果：原点在像素 (81, 11)，在范围内 ✓
```

### 原点在左下角
```python
map_data = {
    "resolution": 0.05,
    "size": [200, 100],
    "origin": [0, 0],        # 左下角恰好是原点
}

# 结果：原点在像素 (0, 100)，超出范围 ✗
# 原因：100 >= height(100)，已超过下边界
```

## 视觉效果

标注显示为：
- 🟢 **绿色圆点**：半径 5 像素
- ➕ **绿色十字**：每个方向 10 像素

颜色：RGB(0, 255, 0) - 纯绿色

## 常见问题

### Q: 为什么有些地图没有显示原点标注？
**A**: 原点坐标可能超出了图像范围。检查 `origin` 和 `size` 参数。

### Q: 如何修改标注样式？
**A**: 编辑 `_mark_origin_on_image()` 中的：
```python
green_color = QColor(0, 255, 0)  # 改变颜色
radius = 5                        # 改变圆点大小
cross_size = 10                   # 改变十字大小
```

### Q: 性能影响大吗？
**A**: 不大。标注操作在毫秒级别完成，仅在地图刷新时执行。

### Q: 支持自定义标注文本吗？
**A**: 当前实现不支持。可扩展 `_mark_origin_on_image()` 方法添加文本。

## 调试技巧

### 查看计算过程
在 `test_origin_mark.py` 中运行，会打印详细的计算过程：
```
地图数据:
  原点 (origin): [-8.1, -4.8]
  分辨率 (resolution): 0.1 m/pixel
  尺寸 (size): [182, 59]

计算结果:
  原点像素位置 (X): 81.0 px
  原点像素位置 (Y from bottom): 48.0 px
  原点像素位置 (Y from top): 11.0 px
  图像范围: X=[0, 182), Y=[0, 59)
✓ 原点在图像范围内，进行标注
```

### 验证生成的图像
```bash
# 查看生成的测试图像
ls -lh /tmp/map_*.png

# 用图像查看器打开
eog /tmp/map_with_origin.png
# 或
feh /tmp/map_with_origin.png
```

## 扩展方向

### 可能的增强
1. **多点标注**：标注多个已知坐标
2. **坐标网格**：绘制参考网格（例如 1m×1m）
3. **标注文本**：添加坐标数值标签
4. **颜色自定义**：根据配置改变标注颜色
5. **标注信息面板**：显示原点到图像边界的距离

### 实现建议
- 在 `map_data` 中添加可选字段控制标注样式
- 创建 `_draw_grid()` 方法绘制参考网格
- 扩展 `_mark_origin_on_image()` 支持多点标注

## 总结表

| 方面 | 描述 |
|------|------|
| **目标** | 在实时地图上标注坐标原点 [0, 0] |
| **方法** | 计算物理坐标到像素坐标的转换，绘制绿色标记 |
| **颜色** | 纯绿色 RGB(0, 255, 0) |
| **标记** | 圆点（r=5px）+ 十字（10px） |
| **范围检查** | 坐标超出范围时跳过标注 |
| **性能** | < 1ms，可忽略 |
| **状态** | ✅ 完成，已测试 |

---

**最后更新**：2026-01-08  
**版本**：1.0  
**状态**：✅ 生产就绪
