# 实时地图显示功能说明

## 功能概述

本次更新为 AMR 设备监控系统添加了实时地图显示功能，可以显示从 WebSocket `/map` 话题接收到的地图数据。

## 新增文件

- `ui/widgets/map_viewer.py` - 地图查看器对话框
- `test_map_viewer.py` - 地图查看器测试脚本

## 功能特性

### 1. 自动订阅 /map 话题

系统启动时会自动从 `topics.txt` 文件读取话题列表，并订阅 `/map` 话题。

### 2. 实时地图显示

- 当接收到 `/map` 话题消息时，系统会自动保存最新的地图数据
- 点击主窗口的 "📍 显示实时地图" 按钮可以打开地图查看器
- 如果地图查看器已打开，接收到新的地图数据时会自动更新显示

### 3. 地图数据格式

系统接收的地图数据格式如下：

```json
{
  "topic": "/map",
  "resolution": 0.1,          // 分辨率（米/像素）
  "size": [182, 59],          // 地图尺寸（像素）
  "origin": [-8.1, -4.8],     // 原点坐标（米）
  "data": "iVBORw0KGgo..." // Base64 编码的 PNG 图片
}
```

### 4. 地图查看器功能

- **地图信息显示**：顶部显示地图的分辨率、尺寸和原点坐标
- **图片显示**：中央区域显示解码后的地图图片
- **自适应缩放**：地图会自动缩放以适应窗口大小，保持宽高比
- **刷新按钮**：手动刷新地图显示
- **滚动支持**：如果地图过大，可以滚动查看

## 使用方法

### 正常使用

1. 确保 `topics.txt` 文件包含 `/map` 话题：
   ```
   /tracked_pose
   /battery_state
   /map
   ```

2. 启动程序：
   ```bash
   python main.py
   ```

3. 程序启动后会自动订阅 `/map` 话题

4. 当设备发布地图数据时：
   - 状态栏会显示 "WS /map 已更新"
   - 最新的地图数据会被保存

5. 点击主窗口的 "📍 显示实时地图" 按钮：
   - 如果有地图数据，会打开地图查看器并显示地图
   - 如果没有地图数据，会提示用户

6. 地图查看器特性：
   - 自动更新：接收到新地图数据时自动刷新显示
   - 窗口可调整大小，地图会自动缩放适应

### 测试功能

如果需要测试地图查看器（不连接实际设备）：

```bash
python test_map_viewer.py
```

这会打开一个测试窗口，点击按钮可以显示测试地图。

## 技术实现

### 主要修改文件

1. **ui/main_window.py**
   - 添加 `latest_map_data` 属性保存最新地图数据
   - 添加 `map_viewer_dialog` 属性保存地图查看器实例
   - 添加 "📍 显示实时地图" 按钮
   - 更新 `_on_topic_message_ui` 方法处理 `/map` 话题
   - 添加 `_on_show_map_clicked` 方法处理按钮点击

2. **ui/widgets/map_viewer.py** (新建)
   - 实现 `MapViewerDialog` 类
   - 提供地图显示和更新功能
   - 支持 Base64 PNG 数据解码和显示

### 核心流程

```
WebSocket 接收 /map 消息
    ↓
_on_topic_message_ui 处理
    ↓
保存到 latest_map_data
    ↓
（可选）自动更新已打开的地图查看器
    ↓
用户点击 "显示实时地图" 按钮
    ↓
MapViewerDialog 显示地图
```

## 错误处理

系统包含完善的错误处理机制：

1. **无地图数据**：如果点击按钮时还没有接收到地图数据，会显示提示对话框
2. **数据解析错误**：如果地图数据格式错误或 Base64 解码失败，会显示错误信息
3. **图片加载失败**：如果 PNG 数据无法加载，会在地图区域显示错误提示

## 注意事项

1. 地图数据必须是 Base64 编码的 PNG 格式图片
2. 系统会保留最新接收到的地图数据，旧数据会被覆盖
3. 地图查看器窗口是非模态的，可以在查看地图的同时操作主窗口
4. 如果地图数据较大，解码和显示可能需要短暂时间

## 调试信息

如果需要调试，可以在相关方法中添加 print 语句：

```python
# 在 _on_topic_message_ui 中
if topic == "/map":
    print(f"收到地图数据: resolution={payload.get('resolution')}, size={payload.get('size')}")
```
