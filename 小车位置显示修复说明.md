# 小车位置显示修复说明

## 问题描述

小车的位置在地图上无法正确显示，即使接收到了`/tracked_pose`话题的数据。

## 问题根源

经过诊断发现，问题出在边界检查逻辑过于严格：

1. **边界检查过严**：原代码只允许±50像素的超出范围，当小车位置稍微超出地图边界时就会被跳过渲染
2. **缺少调试日志**：没有足够的日志输出来帮助诊断问题
3. **缺少位置状态显示**：详细信息中没有显示小车和beacon的位置状态

## 修复内容

### 1. 放宽边界检查（核心修复）

修改了两个类中的位置标注方法：
- `MapViewerDialog._mark_tracked_pose_on_image()`
- `MapViewerDialog._mark_beacon_on_image()`  
- `MapViewerWidget._mark_tracked_pose_on_image()`
- `MapViewerWidget._mark_beacon_on_image()`

**主要变更：**
```python
# 之前：只允许±50像素范围
if not (-50 <= pixel_x < size[0] + 50 and -50 <= pixel_y < size[1] + 50):
    return pixmap

# 修复后：允许±100像素范围，并添加详细日志
boundary_margin = 100
if not (-boundary_margin <= pixel_x < size[0] + boundary_margin and 
        -boundary_margin <= pixel_y < size[1] + boundary_margin):
    logger.warning(f"   ⚠️ 小车位置严重超出显示范围，跳过标注")
    return pixmap

# 即使超出地图范围，只要在扩展范围内仍然显示（部分可见）
in_map_range = (0 <= pixel_x < size[0] and 0 <= pixel_y < size[1])
if not in_map_range:
    logger.warning(f"   ⚠️ 小车位置超出地图范围但仍然标注（部分可见）")
else:
    logger.info(f"   ✅ 小车位置在地图范围内")
```

### 2. 增强调试日志

为所有标注方法添加了详细的日志输出：

```python
logger.info(f"🚗 小车位置标注:")
logger.info(f"   物理坐标: ({pos[0]:.2f}, {pos[1]:.2f})m")
logger.info(f"   地图范围: X[{map_x_min:.2f}, {map_x_max:.2f}]m, Y[{map_y_min:.2f}, {map_y_max:.2f}]m")
logger.info(f"   像素坐标: ({pixel_x:.1f}, {pixel_y:.1f})px")
logger.info(f"   地图尺寸: {size[0]}x{size[1]}px")
```

### 3. 详细信息显示

在地图查看器的详细信息面板中添加了位置状态：

```
🚗 小车位置: (2.50, 1.30)m ⚠️ 超出范围
   朝向: 0.79rad (45.0°)

🔴 Beacon位置: (3.20, 2.10)m ✅
   置信度: 0.95
```

### 4. 启用日志输出

在`main.py`中配置日志系统：

```python
import logging

logging.basicConfig(
    level=logging.INFO,  # 设置为INFO级别以查看标注信息
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout),  # 输出到终端
    ]
)
```

## 修改的文件

1. **ui/widgets/map_viewer.py**
   - 修改了4个标注方法的边界检查逻辑
   - 添加了详细的日志输出
   - 增强了详细信息显示

2. **main.py**
   - 添加了日志配置

3. **diagnose_position.py** (新建)
   - 创建了诊断脚本，用于分析位置显示问题

## 使用方法

### 1. 运行诊断脚本

在遇到问题时，可以先运行诊断脚本：

```bash
python diagnose_position.py
```

这会显示：
- 地图数据格式检查
- 坐标转换过程演示
- 位置范围检查
- 常见问题清单

### 2. 启动应用并查看日志

```bash
python main.py
```

当小车位置更新时，终端会显示详细的日志信息：

```
2026-01-08 10:30:45 - ui.widgets.map_viewer - INFO - 🚗 小车位置标注 (Dialog):
2026-01-08 10:30:45 - ui.widgets.map_viewer - INFO -    物理坐标: (2.50, 1.30)m, 朝向: 0.79rad (45.0°)
2026-01-08 10:30:45 - ui.widgets.map_viewer - INFO -    地图范围: X[-8.10, 10.10]m, Y[-4.80, 1.10]m
2026-01-08 10:30:45 - ui.widgets.map_viewer - INFO -    像素坐标: (106.0, -2.0)px
2026-01-08 10:30:45 - ui.widgets.map_viewer - INFO -    地图尺寸: 182x59px
2026-01-08 10:30:45 - ui.widgets.map_viewer - WARNING -    ⚠️ 小车位置超出地图范围但仍然标注（部分可见）
```

### 3. 查看详细信息

打开地图查看器后，在"详细信息"面板可以看到：
- 小车位置和状态（✅在范围内 或 ⚠️超出范围）
- Beacon位置和状态
- 朝向角度

## 技术细节

### 坐标转换公式

```python
# 全局坐标（米）-> 像素坐标
pixel_x = (pos_x - origin_x) / resolution
pixel_y_from_bottom = (pos_y - origin_y) / resolution
pixel_y = size[1] - pixel_y_from_bottom  # PNG坐标系Y轴反向
```

### 边界检查策略

1. **严格边界**：±100像素扩展范围
   - 超出此范围的位置会被跳过（不渲染）
   - 这避免了过度超出导致的渲染问题

2. **地图边界**：0 到 size范围
   - 在地图边界内：正常渲染，日志显示 ✅
   - 超出地图边界但在扩展范围内：仍然渲染，日志显示 ⚠️

### 为什么放宽到±100像素？

- 地图通常有更新延迟，小车可能短暂超出地图边界
- 允许部分可见有助于用户了解小车相对于地图的位置
- 100像素在典型分辨率（0.05-0.1m/px）下约5-10米，这是合理的缓冲区

## 验证方法

1. **检查topics.txt文件**
   ```bash
   cat topics.txt
   ```
   确保包含：
   ```
   /tracked_pose
   /map
   ```

2. **检查WebSocket连接**
   - 启动应用后查看状态栏
   - 应显示"已订阅: /tracked_pose, /map, ..."

3. **检查数据接收**
   - 状态栏会显示位置更新： "📍 AMR位置: (x, y)m"
   - 地图更新： "🗺️ 地图已更新"

4. **检查地图显示**
   - 点击"📍 显示实时地图"按钮
   - 地图上应显示：
     - 🟢 绿色点：坐标原点[0,0]
     - 🔵 蓝色箭头：小车位置和朝向
     - 🔴 红色点：Beacon位置（如果有）

## 常见问题

### Q1: 小车位置超出地图范围怎么办？

**A**: 现在系统会继续显示超出地图边界的小车（在±100像素范围内），并在详细信息中标记为"⚠️ 超出范围"。如果需要看到完整的小车位置，可能需要：
- 更新地图数据以包含更大范围
- 检查小车的全局坐标是否正确

### Q2: 日志信息太多怎么办？

**A**: 可以在`main.py`中调整日志级别：
```python
logging.basicConfig(
    level=logging.WARNING,  # 只显示警告和错误
    # 或
    level=logging.DEBUG,  # 显示所有调试信息
)
```

### Q3: 为什么有时看不到小车标注？

**A**: 可能的原因：
1. 小车位置严重超出范围（超过±100像素）
2. 地图数据未接收到
3. /tracked_pose话题未订阅或数据格式错误

检查终端日志以获取详细信息。

## 性能考虑

- 放宽边界检查不会影响性能
- 日志输出对性能影响很小
- 标注渲染在Qt的painter中高效执行

## 后续改进建议

1. **自适应地图范围**：根据小车位置动态调整显示的地图区域
2. **历史轨迹显示**：在地图上显示小车的历史移动轨迹
3. **配置化边界**：允许用户在配置文件中调整边界扩展范围
4. **小地图**：添加一个总览小地图，显示小车在完整地图中的位置

## 总结

此次修复主要通过**放宽边界检查**和**增强日志输出**解决了小车位置显示问题。修复后：

✅ 小车位置可以在超出地图边界时继续显示（在合理范围内）
✅ 详细的日志输出帮助诊断问题
✅ 详细信息面板显示位置状态
✅ 更好的用户体验和可维护性

---

**修复时间**: 2026-01-08
**修复人**: AI Assistant
**测试状态**: 待测试
