# 追踪位置标注功能说明

## 功能描述

在实时地图上实时标注机器人的追踪位置和朝向，使用蓝色小箭头进行可视化。

## 功能特性

- **实时位置显示**: 根据 `/tracked_pose` 话题接收的位置数据，实时在地图上标注
- **朝向指示**: 箭头方向指向机器人的运动朝向
- **坐标转换**: 自动将物理世界坐标转换为地图像素坐标
- **多标记支持**: 同时显示坐标原点（绿色）和追踪位置（蓝色）

## 数据格式

### 输入数据格式

```python
pose_data = {
    "pos": [x, y],      # 位置坐标，单位为米
    "ori": angle        # 朝向，单位为弧度（弧度制）
}
```

### 坐标系统

- **X轴**: 向右为正方向（0 弧度）
- **Y轴**: 向上为正方向（π/2 弧度）
- **角度范围**: 0 ~ 2π 或 -π ~ π

### 朝向映射

| 朝向 | 角度（弧度） | 角度（度数） | 方向 |
|------|-------------|-----------|------|
| 向右 | 0 | 0° | X正方向 |
| 向上 | π/2 | 90° | Y正方向 |
| 向左 | π 或 -π | 180° | X负方向 |
| 向下 | -π/2 | -90° 或 270° | Y负方向 |

## 坐标转换原理

### 物理坐标 → 像素坐标

```python
# 给定参数
origin = [x0, y0]      # 地图左下角的物理坐标（米）
resolution = res       # 分辨率（米/像素）
size = [width, height] # 图片尺寸（像素）
pos = [x, y]          # 追踪位置的物理坐标（米）

# 计算像素坐标
pixel_x = (x - x0) / res
pixel_y_from_bottom = (y - y0) / res
pixel_y = height - pixel_y_from_bottom  # 转换到PNG坐标系
```

### 具体例子

```
地图参数:
  origin = [-8.1, -4.8]
  resolution = 0.1 m/pixel
  size = [182, 59]

追踪位置:
  pos = [0.0, 0.0]     # 在物理世界坐标原点
  ori = 0              # 朝向X正方向

计算:
  pixel_x = (0.0 - (-8.1)) / 0.1 = 81.0
  pixel_y = 59 - ((0.0 - (-4.8)) / 0.1) = 59 - 48 = 11.0

结果:
  在地图上的像素位置: (81, 11)
  显示为蓝色圆点和向右的箭头
```

## 可视化标记

### 坐标原点标记（绿色）
- **标记**: 圆点 + 十字
- **颜色**: 纯绿色 RGB(0, 255, 0)
- **含义**: 物理世界坐标系的原点 [0, 0]

### 追踪位置标记（蓝色）
- **标记**: 圆点 + 箭头
- **颜色**: 深蓝色 RGB(0, 150, 255)
- **圆点半径**: 4 像素
- **箭头长度**: 15 像素
- **含义**: 机器人当前位置和朝向

## 使用方法

### 1. 更新地图数据

```python
map_data = {
    "topic": "/map",
    "resolution": 0.1,
    "size": [182, 59],
    "origin": [-8.1, -4.8],
    "data": base64_encoded_png
}
viewer.update_map(map_data)
```

### 2. 更新追踪位置

```python
pose_data = {
    "pos": [0.5, 1.2],      # 机器人位置（米）
    "ori": 0.785            # 机器人朝向（弧度，45°）
}
viewer.update_tracked_pose(pose_data)
```

### 3. 位置更新时自动刷新地图

调用 `update_tracked_pose()` 时会自动：
1. 保存最新的追踪数据
2. 刷新地图显示
3. 重新绘制所有标记

## 实现细节

### 主要方法

#### `update_tracked_pose(pose_data: dict)`

更新追踪位置数据。

```python
def update_tracked_pose(self, pose_data: dict):
    """
    更新追踪位置数据
    
    Args:
        pose_data: 包含位置和朝向信息的字典
                  {"pos": [x, y], "ori": angle_in_radians}
    """
    self.tracked_pose = pose_data
    self._refresh_map()
```

#### `_mark_tracked_pose_on_image(pixmap, map_data, pose_data)`

在图像上绘制追踪位置标记。

```python
def _mark_tracked_pose_on_image(self, pixmap, map_data, pose_data):
    # 1. 提取位置和朝向数据
    # 2. 转换到像素坐标
    # 3. 检查是否在图像范围内
    # 4. 绘制蓝色圆点和箭头
    # 5. 返回标注后的pixmap
```

### 绘制流程

```
_refresh_map()
  ↓
  解码地图图片
  ↓
  标注坐标原点 (_mark_origin_on_image)
  ↓
  标注追踪位置 (_mark_tracked_pose_on_image)
  ↓
  缩放显示
```

## 边界情况处理

### 追踪位置超出图像范围

当计算出的追踪位置超出地图范围时：
- 自动跳过标注
- 地图正常显示（仅显示原点）
- 无错误提示

### 无追踪数据

- 如果 `tracked_pose` 为 None，跳过追踪位置绘制
- 仅显示坐标原点和地图

### 数据字段缺失

- 缺少 `pos` 或 `ori` 字段：跳过标注
- 位置数据无效：检查范围后决定是否显示

## 坐标系统注意事项

### Y轴方向反转

PNG图像坐标系与物理世界坐标系的Y轴方向相反：
- **物理世界**: Y向上为正
- **PNG图像**: Y向下为正

因此在计算像素Y坐标时需要翻转：
```python
pixel_y = height - pixel_y_from_bottom
```

### 朝向角度计算

在绘制箭头时，需要考虑PNG的Y轴反向：
```python
# 物理世界坐标系中的角度
arrow_end_y = pixel_y - arrow_length * math.sin(ori)
# 注意: 减号是因为PNG的Y轴反向
```

## 测试方法

运行测试脚本：
```bash
python test_tracked_pose.py
```

输出结果包含5个测试用例：
1. 朝向X正方向（向右，0°）
2. 朝向Y正方向（向上，90°）
3. 朝向X负方向（向左，180°）
4. 朝向Y负方向（向下，-90°）
5. 45度朝向

每个测试生成一个标注后的地图图像，保存在 `/tmp/test_tracked_pose_*.png`

## 集成到主应用

### 在 MainWindow 中使用

```python
# 创建地图查看器
self.map_viewer = MapViewerDialog()

# 接收地图数据时
def on_map_received(self, map_data):
    self.map_viewer.update_map(map_data)

# 接收追踪位置数据时
def on_pose_received(self, pose_data):
    self.map_viewer.update_tracked_pose(pose_data)
```

### WebSocket 订阅

```python
# 订阅 /map 话题
ws.subscribe_topic("/map", lambda msg: on_map_received(msg))

# 订阅 /tracked_pose 话题
ws.subscribe_topic("/tracked_pose", lambda msg: on_pose_received(msg))
```

## 性能考虑

- **绘制时间**: < 5ms（取决于箭头绘制）
- **内存占用**: 额外绘制一个箭头，增加内存可忽略
- **更新频率**: 支持高频更新（> 10Hz）

## 扩展建议

### 可能的增强

1. **多机器人支持**
   - 使用不同的颜色区分多个机器人
   - 存储多个 tracked_pose 数据

2. **轨迹记录**
   - 记录历史位置点
   - 绘制机器人运动轨迹

3. **追踪信息显示**
   - 在箭头旁显示位置坐标
   - 显示速度和角速度信息

4. **自定义标记样式**
   - 允许用户自定义箭头大小、颜色
   - 支持不同的标记形状

## 总结

追踪位置标注功能提供了实时、精确的机器人位置和朝向可视化，帮助用户快速了解机器人的当前状态和运动方向。

---

**相关文件**:
- `ui/widgets/map_viewer.py` - 核心实现
- `test_tracked_pose.py` - 测试脚本
