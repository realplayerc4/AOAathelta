# å®æ—¶åœ°å›¾ç³»ç»Ÿ - åŠŸèƒ½é›†æˆæ€»ç»“

## æ ¸å¿ƒåŠŸèƒ½

### 1. åæ ‡åŸç‚¹æ ‡æ³¨ [0,0]
- **æ ‡è®°**: ç»¿è‰²åœ†ç‚¹ï¼ˆr=5pxï¼‰+ åå­—ï¼ˆ10pxï¼‰
- **è®¡ç®—å…¬å¼**:
```python
x_pixel = -origin[0] / resolution
y_pixel = height - (-origin[1] / resolution)
```
- **èŒƒå›´æ£€æŸ¥**: è¶…å‡ºå›¾åƒèŒƒå›´æ—¶è·³è¿‡æ ‡æ³¨
- **æ–‡ä»¶**: `ui/widgets/map_viewer.py` - `_mark_origin_on_image()`

### 2. è¿½è¸ªä½ç½®æ ‡æ³¨ï¼ˆAMR ä½ç½®/æœå‘ï¼‰
- **æ ‡è®°**: è“è‰²åœ†ç‚¹ï¼ˆr=4pxï¼‰+ ç®­å¤´ï¼ˆ15pxï¼‰
- **è¾“å…¥**: `{"pos": [x, y], "ori": angle_rad}`
- **è®¡ç®—å…¬å¼**:
```python
pixel_x = (pos[0] - origin[0]) / resolution
pixel_y = height - ((pos[1] - origin[1]) / resolution)
```
- **ç®­å¤´æ–¹å‘**: æ ¹æ® `ori`ï¼ˆå¼§åº¦ï¼‰è®¡ç®—
- **æ–‡ä»¶**: `ui/widgets/map_viewer.py` - `_mark_tracked_pose_on_image()`

### 3. åœ°å›¾åˆ—è¡¨æ˜¾ç¤º
- ç¼©ç•¥å›¾æ˜¾ç¤ºï¼ˆ150Ã—150ï¼‰
- å¼‚æ­¥ä¸‹è½½ï¼Œä¸é˜»å¡UI
- æ˜¾ç¤ºåœ°å›¾åç§°ã€IDã€åˆ†è¾¨ç‡ã€å¤§å°ç­‰
- **æ–‡ä»¶**: `ui/widgets/map_table.py`

### 4. å®æ—¶åœ°å›¾æŸ¥çœ‹å™¨
- è‡ªåŠ¨è®¢é˜… `/map` è¯é¢˜
- æ”¯æŒæ‰‹åŠ¨åˆ·æ–°
- è‡ªé€‚åº”ç¼©æ”¾
- **æ–‡ä»¶**: `ui/widgets/map_viewer.py`

---

## å¿«é€Ÿé›†æˆæ­¥éª¤

### Step 1: éªŒè¯ topics.txt
```
/tracked_pose
/battery_state
/map
```

### Step 2: åœ¨ MainWindow ä¸­è®¢é˜…è¯é¢˜
```python
from ui.widgets.map_viewer import MapViewerDialog

# åˆå§‹åŒ–
self.map_viewer = MapViewerDialog(self)

# è®¢é˜…åœ°å›¾
self.ws_subscriber.subscribe_topic("/map", self._on_map_received)

# è®¢é˜…è¿½è¸ªä½ç½® (æ–°å¢)
self.ws_subscriber.subscribe_topic("/tracked_pose", self._on_tracked_pose_received)
```

### Step 3: å¤„ç†æ¶ˆæ¯
```python
def _on_map_received(self, payload):
    try:
        map_data = json.loads(payload)
        self.map_viewer.update_map(map_data)
    except Exception as e:
        logger.error(f"åœ°å›¾é”™è¯¯: {e}")

def _on_tracked_pose_received(self, payload):
    try:
        msg = json.loads(payload)
        pose_data = {"pos": [msg["pos"]["x"], msg["pos"]["y"]], "ori": msg["ori"]}
        self.map_viewer.update_tracked_pose(pose_data)
    except Exception as e:
        logger.error(f"ä½ç½®é”™è¯¯: {e}")
```

### Step 4: æ·»åŠ  UI æŒ‰é’®
```python
# åœ¨ä¸»çª—å£æ·»åŠ æŒ‰é’®è§¦å‘åœ°å›¾æ˜¾ç¤º
map_button = QPushButton("ğŸ“ æ˜¾ç¤ºå®æ—¶åœ°å›¾")
map_button.clicked.connect(self._on_show_map_clicked)
```

---

## API å‚è€ƒ

### MapViewerDialog

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `update_map(map_data: dict)` | æ›´æ–°å¹¶æ˜¾ç¤ºåœ°å›¾ |
| `update_tracked_pose(pose_data: dict)` | æ›´æ–°è¿½è¸ªä½ç½®ï¼Œè‡ªåŠ¨åˆ·æ–° |
| `show()` | æ˜¾ç¤ºçª—å£ |

### æ•°æ®æ ¼å¼

**åœ°å›¾æ•°æ®**:
```json
{
  "resolution": 0.1,
  "size": [182, 59],
  "origin": [-8.1, -4.8],
  "data": "base64_png_data"
}
```

**è¿½è¸ªä½ç½®**:
```json
{
  "pos": [0.5, 1.2],
  "ori": 0.785
}
```

---

## æµ‹è¯•

```bash
# åŸºç¡€æµ‹è¯•
python test_origin_mark.py              # åŸç‚¹æ ‡æ³¨
python test_tracked_pose.py             # è¿½è¸ªä½ç½®
python test_map_viewer.py               # åœ°å›¾æŸ¥çœ‹å™¨

# é›†æˆæµ‹è¯•
python test_integration.py              # æ‰€æœ‰åŠŸèƒ½

# è¿è¡Œä¸»åº”ç”¨
python main.py
```

---

## å…³é”®ç®—æ³•

### åæ ‡ç³»è½¬æ¢

```
ç‰©ç†ä¸–ç•Œåæ ‡ç³» (XY) 
  â†“
å‡å»åŸç‚¹åç§»
  â†“
é™¤ä»¥åˆ†è¾¨ç‡ (å¾—åƒç´ åæ ‡)
  â†“
Yè½´ç¿»è½¬ (PNGåæ ‡ç³»)
  â†“
PNGåƒç´ åæ ‡
```

### èŒƒå›´æ£€æŸ¥
```python
if 0 <= pixel_x < width and 0 <= pixel_y < height:
    # åœ¨èŒƒå›´å†…ï¼Œè¿›è¡Œæ ‡æ³¨
```

---

## å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|--------|
| çœ‹ä¸åˆ°ç»¿ç‚¹ | æ£€æŸ¥ origin æ˜¯å¦ä½¿å¾— [0,0] åœ¨å›¾ç‰‡èŒƒå›´å†… |
| çœ‹ä¸åˆ°è“ç®­å¤´ | æ£€æŸ¥ pos åæ ‡æ˜¯å¦åœ¨åœ°å›¾èŒƒå›´å†…ï¼›éªŒè¯ ori å•ä½æ˜¯å¦ä¸ºå¼§åº¦ |
| æ€§èƒ½å¡é¡¿ | é™ä½æ›´æ–°é¢‘ç‡æˆ–å‡å°åœ°å›¾åˆ†è¾¨ç‡ |
| ä½ç½®é”™ä¹± | éªŒè¯åæ ‡ç³»å®šä¹‰ï¼ˆorigin æ˜¯å¦ä¸ºå·¦ä¸‹è§’ï¼‰|

---

## æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `ui/widgets/map_viewer.py` | **æ ¸å¿ƒ** - åœ°å›¾æ˜¾ç¤º+åŸç‚¹+è¿½è¸ªä½ç½®æ ‡æ³¨ |
| `ui/widgets/map_table.py` | åœ°å›¾åˆ—è¡¨æ˜¾ç¤º |
| `ui/main_window.py` | ä¸»çª—å£é›†æˆ |
| `models/map.py` | åœ°å›¾æ•°æ®æ¨¡å‹ |
| `test_*.py` | å„åŠŸèƒ½æµ‹è¯•è„šæœ¬ |

---

## çŠ¶æ€

âœ… åŸç‚¹æ ‡æ³¨ - å®Œæˆ  
âœ… è¿½è¸ªä½ç½®æ ‡æ³¨ - å®Œæˆ  
âœ… åœ°å›¾åˆ—è¡¨ - å®Œæˆ  
âœ… å®æ—¶æŸ¥çœ‹å™¨ - å®Œæˆ  
âœ… æ–‡æ¡£å®Œæ•´ - å®Œæˆ  

**å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒ**
