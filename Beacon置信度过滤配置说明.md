# Beacon 置信度过滤配置说明

## 📌 功能说明

为解决由于低置信度数据导致的 beacon 位置漂移问题，系统现在会**自动过滤低置信度的 beacon 数据**，只采信高质量的测量结果。

---

## ⚙️ 配置方法

### 修改置信度阈值

在 `config.py` 文件中调整：

```python
# Beacon 数据过滤配置
BEACON_MIN_CONFIDENCE = 0.70  # 最小置信度阈值（0.0-1.0）
```

**推荐值**：
- `0.70` (70%) - **默认值**，适合大多数场景
- `0.60` (60%) - 如果数据较少，可适当降低
- `0.80` (80%) - 如果要求更高精度，可提高阈值
- `0.50` (50%) - 数据质量较差时的最低建议值

---

## 🔍 工作原理

### 过滤流程

```
AOA数据到达
     ↓
提取置信度
     ↓
置信度 >= 70% ?
     ↓
  ┌─YES─┐      ┌─NO──┐
  ↓      ↓      ↓     ↓
接受数据  计算   丢弃数据  记录
更新位置  全局   不更新    警告日志
         坐标
```

### 代码逻辑

```python
# 检查置信度
if confidence < config.BEACON_MIN_CONFIDENCE:
    logger.warning(f"⚠️ Beacon数据置信度过低，已过滤")
    return  # 丢弃数据

# 置信度达标，接受数据
self.latest_filtered_beacon = {...}
logger.info(f"✅ 接受Beacon数据: 置信度={confidence:.2%}")
```

---

## 📊 日志输出

### 接受的数据（置信度 ≥ 70%）

```
✅ 接受Beacon数据: x=1.234m, y=0.567m, 置信度=75.23%
🔄 Beacon全局位置已更新: (3.45, 2.10)m
```

### 被过滤的数据（置信度 < 70%）

```
⚠️ Beacon数据置信度过低(65.42% < 70.00%)，已过滤
   被过滤的数据: x=1.823m, y=-0.234m
```

---

## 🎯 效果对比

### 过滤前

```
时间    X坐标   Y坐标   置信度   状态
10:00  1.23    0.56    0.85    ✅ 稳定
10:01  1.25    0.58    0.82    ✅ 稳定
10:02  2.89    -1.34   0.45    ❌ 漂移！
10:03  1.24    0.57    0.83    ✅ 恢复
10:04  3.12    2.11    0.38    ❌ 漂移！
```

**问题**：低置信度数据导致位置突然跳变

### 过滤后（阈值 70%）

```
时间    X坐标   Y坐标   置信度   状态
10:00  1.23    0.56    0.85    ✅ 接受
10:01  1.25    0.58    0.82    ✅ 接受
10:02  ---     ---     0.45    🚫 过滤
10:03  1.24    0.57    0.83    ✅ 接受
10:04  ---     ---     0.38    🚫 过滤
```

**优势**：只使用高质量数据，位置更稳定

---

## 📈 不同阈值的影响

| 阈值 | 数据接受率 | 位置稳定性 | 更新频率 | 推荐场景 |
|-----|-----------|-----------|---------|---------|
| 50% | ~90% | ⭐⭐ | 高 | 数据质量差时 |
| 60% | ~80% | ⭐⭐⭐ | 较高 | 平衡模式 |
| **70%** | ~60% | **⭐⭐⭐⭐** | **中等** | **推荐（默认）** |
| 80% | ~40% | ⭐⭐⭐⭐⭐ | 较低 | 高精度要求 |
| 90% | ~20% | ⭐⭐⭐⭐⭐ | 低 | 极高精度要求 |

---

## 🛠️ 配置示例

### 场景1：室内稳定环境

```python
# config.py
BEACON_MIN_CONFIDENCE = 0.70  # 标准配置
```

### 场景2：复杂环境（干扰多）

```python
# config.py
BEACON_MIN_CONFIDENCE = 0.80  # 提高阈值，只要最好的数据
```

### 场景3：信号较弱环境

```python
# config.py
BEACON_MIN_CONFIDENCE = 0.60  # 降低阈值，保证足够数据
```

### 场景4：测试/调试

```python
# config.py
BEACON_MIN_CONFIDENCE = 0.50  # 最低阈值，观察所有数据
```

---

## 📝 监控方法

### 1. 观察终端日志

```bash
python main.py
```

**关注信息**：
- ✅ 绿色对勾：数据被接受
- ⚠️ 警告符号：数据被过滤
- 置信度百分比

### 2. 统计过滤率

运行一段时间后，统计：
```
接受的数据数量 / 总数据数量 = 接受率
```

**建议**：
- 接受率 > 50%：阈值合理
- 接受率 < 30%：考虑降低阈值
- 接受率 > 80%：可考虑提高阈值

### 3. 观察位置稳定性

在地图查看器中观察：
- Beacon 红点是否稳定
- 是否还有明显跳变
- 轨迹是否平滑

---

## 🚀 快速调整步骤

1. **打开配置文件**
   ```bash
   nano config.py
   # 或使用你喜欢的编辑器
   ```

2. **修改阈值**
   ```python
   BEACON_MIN_CONFIDENCE = 0.70  # 改为你需要的值
   ```

3. **保存并重启**
   ```bash
   python main.py
   ```

4. **观察效果**
   - 查看终端日志
   - 观察地图上的位置
   - 记录接受率和稳定性

5. **微调优化**
   - 如果过滤太多：降低阈值（-0.05）
   - 如果还有跳变：提高阈值（+0.05）

---

## ⚡ 高级配置

### 动态调整（未来可扩展）

如果需要根据环境动态调整，可以在代码中添加：

```python
# 根据最近数据质量动态调整阈值
recent_avg_confidence = ...  # 计算最近N帧的平均置信度
if recent_avg_confidence > 0.85:
    dynamic_threshold = 0.75  # 质量好时提高标准
elif recent_avg_confidence < 0.60:
    dynamic_threshold = 0.55  # 质量差时降低标准
else:
    dynamic_threshold = 0.70  # 正常标准
```

---

## 🐛 故障排除

### 问题1：过滤太多，更新太慢

**症状**：大量警告日志，beacon 位置长时间不更新

**解决**：
```python
BEACON_MIN_CONFIDENCE = 0.60  # 降低阈值
```

### 问题2：仍然有跳变

**症状**：即使过滤后，位置还是不稳定

**解决**：
```python
BEACON_MIN_CONFIDENCE = 0.80  # 提高阈值
```

或检查：
- 卡尔曼滤波器是否启用
- 硬件信号质量
- 环境干扰因素

### 问题3：没有任何数据通过

**症状**：所有数据都被过滤

**原因**：
- 阈值设置太高
- 卡尔曼滤波器未正常工作
- 硬件信号质量极差

**解决**：
1. 临时降低阈值到 0.30 观察
2. 检查滤波器配置
3. 检查硬件连接

---

## 📖 相关文档

- [实时位置更新优化说明.md](实时位置更新优化说明.md) - 位置更新机制
- [小车位置显示_快速参考.md](小车位置显示_快速参考.md) - 快速参考
- [卡尔曼滤波快速开始.md](卡尔曼滤波快速开始.md) - 滤波器配置

---

**更新日期**: 2026-01-08  
**默认配置**: BEACON_MIN_CONFIDENCE = 0.70 (70%)
