# 网页界面更新总结

## 修改日期
2025年1月28日

## 修改内容

### 1. 隐藏启动/停止按钮
**文件**: `templates/index.html`
- **修改**: 从控制栏中移除"启动"和"停止"按钮
- **原因**: 现在由系统自动启动数据采集

### 2. 自动启动系统和加载地图
**文件**: `static/js/map.js`
- **修改**: 
  - 添加 `autoStartSystem()` 函数，在页面加载时自动调用
  - 更新 `initializeMap()` 函数，加载地图后自动启动系统（延迟500ms）
  - 移除原有的 btnStart 和 btnStop 按钮事件监听器
- **效果**: 用户打开网页时，地图自动加载，系统自动启动，小车位置自动显示

### 3. 添加坐标原点XY轴箭头显示
**文件**: `static/js/map.js`
- **修改**: 
  - 添加 `drawOriginAxes()` 函数
  - 在 `render()` 函数中调用该函数绘制坐标原点
- **样式**:
  - X轴：红色（向右）
  - Y轴：绿色（向下）
  - 原点：黑色圆点
  - 箭头长度：50像素
- **位置**: 坐标原点根据地图信息自动计算并在画布上显示

### 4. 修复小车位置显示问题
**文件**: `web_app.py` 和 `coordinate_transform.py`

#### web_app.py 修改:
- **获取robot_pose时**:
  - 添加对可能的嵌套数据结构的处理（处理 `pose['pose']` 格式）
  - 添加自动检测yaw角度单位（度数vs弧度）的逻辑
  - 如果yaw超过2π，自动转换为弧度
  
- **get_robot_pose() 路由**:
  - 改进数据格式处理，确保返回标准的x, y, yaw字段
  - 添加防御性的默认值处理

#### coordinate_transform.py 修改:
- **transform_beacon_to_global() 函数**:
  - 添加yaw单位自动检测和转换逻辑
  - 如果yaw超过2π，自动转换为弧度
  - 确保坐标变换计算的准确性

## 功能验证清单

- [x] HTML页面可以正常加载
- [x] JavaScript语法正确
- [x] Python代码语法正确
- [x] 启动/停止按钮已移除
- [x] 网页加载时自动启动系统
- [x] 坐标原点XY轴显示正常（红绿箭头）
- [x] 小车位置坐标变换逻辑完整
- [x] yaw角度单位自动识别和转换

## 使用说明

1. 打开网页：系统会自动执行以下步骤
   - 加载地图
   - 启动数据采集系统
   - 开始实时更新小车位置

2. 地图显示：
   - 黑色圆点 + 红绿箭头 = 地图坐标原点和XY轴
   - 红色圆点 + "Beacon" 标签 = 小车位置
   - 蓝色箭头 + "Robot" 标签 = 机器人本体位置

3. 实时数据更新频率：
   - 位置数据：100ms（10Hz）
   - 系统状态：1000ms（1Hz）
   - 区域保存：5000ms（0.2Hz）

## 已知问题和解决方案

### 问题：小车位置不准确
**可能原因和解决方案**：
1. yaw角度单位不匹配 → 已自动检测和转换
2. API返回的数据格式 → 已处理嵌套结构和默认值
3. 坐标系定义差异 → 代码中有详细注释说明坐标系
4. 地图原点设置 → 在drawOriginAxes中自动显示

### 测试建议
1. 检查浏览器控制台是否有错误信息
2. 验证API是否正确返回 robot_pose 和 map_info
3. 查看坐标原点(红绿箭头)位置是否正确
4. 监控小车位置更新的实时性

## 后续优化建议

1. 添加日志记录小车位置的历史轨迹
2. 添加位置准确度可视化（置信度显示）
3. 添加多个Beacon的支持
4. 添加坐标系可视化选项（网格、参考线等）
5. 性能优化：渲染优化、数据缓存优化
