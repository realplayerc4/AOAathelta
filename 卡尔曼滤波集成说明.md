# å¡å°”æ›¼æ»¤æ³¢é›†æˆæŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆæ‰©å±•å¡å°”æ›¼æ»¤æ³¢å™¨ (Extended Kalman Filter, EKF)ï¼ŒåŸºäº `AOA/src/kalman_filter_node.py` çš„å®ç°ï¼Œç”¨äºæé«˜ AOA å®šä½æ ‡ç­¾çš„å‡†ç¡®ç‡ã€‚

## æ ¸å¿ƒç‰¹æ€§

### 1. å•ç›®æ ‡å¡å°”æ›¼æ»¤æ³¢ (`KalmanFilter`)

å¯¹å•ä¸ªæ ‡ç­¾çš„æµ‹é‡å€¼è¿›è¡Œæ»¤æ³¢ï¼š

- **çŠ¶æ€å‘é‡**: `[x, y, vx, vy, ax, ay]`
  - ä½ç½® (x, y)
  - é€Ÿåº¦ (vx, vy)
  - åŠ é€Ÿåº¦ (ax, ay)

- **è¿åŠ¨æ¨¡å‹**: æ’åŠ é€Ÿåº¦æ¨¡å‹
- **æµ‹é‡æ¨¡å‹**: ç›´æ¥è§‚æµ‹ä½ç½® (æåæ ‡ â†’ ç¬›å¡å°”åæ ‡)

### 2. å¤šç›®æ ‡å¡å°”æ›¼æ»¤æ³¢ (`MultiTargetKalmanFilter`)

ä¸ºæ¯ä¸ªæ ‡ç­¾ç»´æŠ¤ç‹¬ç«‹çš„æ»¤æ³¢å™¨å®ä¾‹ï¼š

- è‡ªåŠ¨ä¸ºæ–°æ ‡ç­¾åˆ›å»ºæ»¤æ³¢å™¨
- æ”¯æŒè¶…æ—¶è‡ªåŠ¨åˆ é™¤æœªæ›´æ–°çš„ç›®æ ‡
- åŒæ—¶è·Ÿè¸ªå¤šä¸ªæ ‡ç­¾

## å‚æ•°é…ç½®

### æ»¤æ³¢å™¨å‚æ•°

```python
kalman_filter = MultiTargetKalmanFilter(
    process_noise=0.1,           # è¿‡ç¨‹å™ªå£°å¼ºåº¦ (è¶Šå°è¶Šç›¸ä¿¡æ¨¡å‹)
    measurement_noise=0.5,       # æµ‹é‡å™ªå£°å¼ºåº¦ (è¶Šå°è¶Šç›¸ä¿¡æµ‹é‡)
    prediction_horizon=0.5,      # é¢„æµ‹æ—¶é—´ (ç§’)
    min_confidence=0.3,          # æœ€å°ç½®ä¿¡åº¦
    target_lost_timeout=2.0      # ç›®æ ‡ä¸¢å¤±è¶…æ—¶æ—¶é—´ (ç§’)
)
```

### æ¨èé…ç½®

| åœºæ™¯ | process_noise | measurement_noise | è¯´æ˜ |
|------|---------------|-------------------|------|
| é«˜ç²¾åº¦ | 0.05 | 0.3 | ç›¸ä¿¡æ¨¡å‹å’Œæµ‹é‡ï¼Œé€‚åˆç¨³å®šè¿åŠ¨ |
| å¹³è¡¡ | 0.1 | 0.5 | é»˜è®¤é…ç½®ï¼Œé€‚åˆä¸€èˆ¬åœºæ™¯ |
| é«˜å™ªå£° | 0.3 | 1.0 | ç›¸ä¿¡æµ‹é‡æ•°æ®ï¼Œé€‚åˆå™ªå£°å¤§çš„ç¯å¢ƒ |
| å¿«é€Ÿè¿åŠ¨ | 0.2 | 0.8 | å¹³è¡¡æ¨¡å‹å’Œæµ‹é‡ï¼Œé€‚åˆç›®æ ‡å¿«é€Ÿç§»åŠ¨ |

## é›†æˆä½ç½®

### 1. AOA æ•°æ®å¤„ç† (`workers/aoa_worker.py`)

**å•ç›®æ ‡æ»¤æ³¢**ï¼šç”¨äºå•ä¸ª ANCHER çš„åŸå§‹æµ‹é‡æ•°æ®

```python
class AOAWorker(QThread):
    def __init__(self, ...):
        self.kalman_filter = MultiTargetKalmanFilter(...)
        self.filter_enabled = True
    
    def _on_frame_received(self, frame: AOAFrame):
        if self.filter_enabled:
            filtered_x, filtered_y, filter_info = self.kalman_filter.filter_measurement(
                tag_id=tag_id,
                distance=distance,
                angle_deg=angle,
                timestamp=time.time()
            )
        # å‘é€æ»¤æ³¢åçš„ä½ç½®
```

**å¤šç›®æ ‡æ»¤æ³¢**ï¼šç”¨äºå¤š ANCHER èåˆå®šä½

```python
class AOADataProcessor(QThread):
    def __init__(self):
        # å¤š ANCHER èåˆå®šä½ä½¿ç”¨æ›´ä½çš„å™ªå£°å‚æ•°
        self.kalman_filter = MultiTargetKalmanFilter(
            process_noise=0.05,
            measurement_noise=0.3,
            ...
        )
    
    def _calculate_position(self, tag_id: int):
        if self.filter_enabled:
            # å¯¹å¤š ANCHER è®¡ç®—çš„ä½ç½®è¿›è¡Œæ»¤æ³¢
            filtered_x, filtered_y, filter_info = self.kalman_filter.filter_measurement(...)
```

### 2. ç”¨æˆ·ç•Œé¢æ§åˆ¶ (`ui/main_window.py`)

æ–°å¢å¡å°”æ›¼æ»¤æ³¢æ§åˆ¶æŒ‰é’®ï¼š

- **æŒ‰é’®**: "ğŸ”¬ ç¦ç”¨å¡å°”æ›¼æ»¤æ³¢"
- **åŠŸèƒ½**: ç‚¹å‡»åˆ‡æ¢æ»¤æ³¢å¯ç”¨/ç¦ç”¨çŠ¶æ€
- **ä½ç½®**: ä¸»çª—å£æ§åˆ¶æ 

## ä½¿ç”¨æ–¹æ³•

### å¯ç”¨/ç¦ç”¨æ»¤æ³¢

```python
# å¯ç”¨æ»¤æ³¢
aoa_worker.enable_filter(True)

# ç¦ç”¨æ»¤æ³¢
aoa_worker.enable_filter(False)

# é‡ç½®æ‰€æœ‰æ»¤æ³¢å™¨çŠ¶æ€
aoa_worker.reset_filter()
```

### è·å–æ»¤æ³¢å™¨çŠ¶æ€

```python
# è·å–ç‰¹å®šæ ‡ç­¾çš„æ»¤æ³¢å™¨çŠ¶æ€
state = aoa_worker.get_filter_state(tag_id=1)
print(state)
# è¾“å‡º:
# {
#     'tag_id': 1,
#     'initialized': True,
#     'x': 1.23,
#     'y': 4.56,
#     'vx': 0.1,      # é€Ÿåº¦
#     'vy': -0.05,
#     'ax': 0.02,     # åŠ é€Ÿåº¦
#     'ay': 0.01,
#     'speed': 0.11,
#     'acceleration': 0.022,
#     'confidence': 0.85,
#     'update_count': 156
# }
```

### é¢„æµ‹æœªæ¥ä½ç½®

```python
# é¢„æµ‹ 1 ç§’åçš„ä½ç½®
future_x, future_y, future_distance, future_angle = filter_obj.predict_future_position(horizon=1.0)
```

## è¾“å‡ºæ•°æ®æ ¼å¼

### å¸§ä¿¡æ¯ (frame_received ä¿¡å·)

```python
{
    'frame_id': 1,
    'timestamp': '2026-01-08 12:34:56.789',
    'anchor_id': 1,
    'tag_id': 101,
    'distance_mm': 5000,
    'angle_degrees': 45.5,
    'voltage_mv': 3300,
    'is_valid': True,
    
    # æ»¤æ³¢åçš„ç»“æœ (filter_enabled=True æ—¶)
    'filtered_x': 3.536,       # ç¬›å¡å°”åæ ‡
    'filtered_y': 3.536,
    'filter_confidence': 0.85,  # æ»¤æ³¢ç½®ä¿¡åº¦
    'velocity_x': 0.1,         # é€Ÿåº¦
    'velocity_y': -0.05
}
```

### ä½ç½®æ›´æ–° (position_calculated ä¿¡å·)

```python
{
    'tag_id': 101,
    'x': 3.536,               # æ»¤æ³¢åçš„ X åæ ‡
    'y': 3.536,               # æ»¤æ³¢åçš„ Y åæ ‡
    'calc_x': 3.535,          # åŸå§‹è®¡ç®—ç»“æœ
    'calc_y': 3.537,
    'distance': 5.0,          # åˆ°åŸç‚¹è·ç¦»
    'angle': 45.0,            # è§’åº¦
    'confidence': 0.87,
    'filtered': True,         # æ˜¯å¦ä½¿ç”¨äº†æ»¤æ³¢
    'velocity_x': 0.12,
    'velocity_y': -0.08,
    'timestamp': '2026-01-08T12:34:56.789'
}
```

## æ€§èƒ½è€ƒè™‘

### è®¡ç®—å¤æ‚åº¦

- **å•ä¸ªæ»¤æ³¢å™¨æ›´æ–°**: O(1) - å¸¸æ•°æ—¶é—´
- **å¤šç›®æ ‡æ»¤æ³¢**: O(n) - n ä¸ºæ´»è·ƒç›®æ ‡æ•°é‡

### å†…å­˜å ç”¨

- **æ¯ä¸ªæ»¤æ³¢å™¨å®ä¾‹**: ~2 KB
- **å¤šç›®æ ‡æ»¤æ³¢å™¨ (100 ä¸ªç›®æ ‡)**: ~200 KB

### å»¶è¿Ÿ

- **é¢„æµ‹æ­¥éª¤**: < 0.1 ms
- **æ›´æ–°æ­¥éª¤**: < 0.2 ms
- **æ€»å»¶è¿Ÿ**: < 0.5 ms (å•ç›®æ ‡)

## æ•…éšœæ’æŸ¥

### é—®é¢˜: æ»¤æ³¢è¾“å‡ºæŠ–åŠ¨

**åŸå› **: æµ‹é‡å™ªå£°å‚æ•°è¿‡å¤§æˆ–è¿‡ç¨‹å™ªå£°è¿‡å°

**è§£å†³æ–¹æ¡ˆ**:
```python
# å¢åŠ è¿‡ç¨‹å™ªå£°æˆ–é™ä½æµ‹é‡å™ªå£°
kalman_filter = MultiTargetKalmanFilter(
    process_noise=0.2,  # å¢å¤§
    measurement_noise=0.3  # å‡å°
)
```

### é—®é¢˜: æ»¤æ³¢è·Ÿè¸ªå»¶è¿Ÿ

**åŸå› **: è¿‡ç¨‹å™ªå£°è¿‡å¤§ï¼Œæ¨¡å‹ä¸å¤Ÿç›¸ä¿¡

**è§£å†³æ–¹æ¡ˆ**:
```python
# å‡å°è¿‡ç¨‹å™ªå£°
kalman_filter = MultiTargetKalmanFilter(
    process_noise=0.05,  # å‡å°
    measurement_noise=0.5
)
```

### é—®é¢˜: æ— æ•ˆä½ç½®æ•°æ®

**åŸå› **: æ ‡ç­¾ä¸¢å¤±è¶…æ—¶æˆ–åˆå§‹åŒ–å¤±è´¥

**æ£€æŸ¥æ–¹æ³•**:
```python
state = aoa_worker.get_filter_state(tag_id)
if not state['initialized']:
    print(f"æ ‡ç­¾ {tag_id} æ»¤æ³¢å™¨æœªåˆå§‹åŒ–")
```

## ä¸ ROS ç‰ˆæœ¬çš„å¯¹æ¯”

| ç‰¹æ€§ | ROS ç‰ˆæœ¬ | æœ¬ç‰ˆæœ¬ |
|------|---------|--------|
| å¹³å° | ROS 2 | PyQt6 |
| æ¶ˆæ¯ç±»å‹ | custom ROS msgs | Python dict |
| å‚æ•°ç®¡ç† | rclpy parameters | ç›´æ¥ä¼ é€’ |
| å¤šçº¿ç¨‹ | rclpy.spin | QThread |
| é¢„æµ‹è¾“å‡º | PredictedTarget msg | dict + æ–¹æ³•è°ƒç”¨ |

## æœ€åæ›´æ–°

- **æ—¥æœŸ**: 2026-01-08
- **ç‰ˆæœ¬**: 1.0.0
- **åŸºäº**: kalman_filter_node.py (AOA project)
