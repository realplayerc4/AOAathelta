# 🤖 小车位置和朝向显示 - 测试指南

## 📌 功能说明

已为 Web UI 添加了**小车（机器人）位置显示**功能，以**蓝色箭头**表示小车的位置和朝向方向。

### 功能特性

| 功能 | 说明 |
|------|------|
| 🔵 **蓝色箭头** | 表示小车位置和朝向 |
| 📍 **实时更新** | 10Hz 频率更新小车位置 |
| 🎯 **朝向指示** | 箭头方向表示小车的朝向角 |
| 📊 **数据显示** | 右下方信息面板显示 X, Y, 朝向角 |
| 🔗 **API 数据** | 从地盘 REST API 获取数据 |

## 🔌 API 配置

### 端点信息

```
API 地址: http://192.168.11.1:1448/api/core/slam/v1/localization/pose
方法: GET
超时: 5 秒
频率: 20 Hz
```

### API 返回数据格式

```json
{
  "x": 5.234,      // 全局坐标系中的 X 位置（米）
  "y": 3.456,      // 全局坐标系中的 Y 位置（米）
  "yaw": 0.785,    // 朝向角（弧度）
  "z": 0.0,        // 高度（通常为 0）
  "pitch": 0.0,    // 俯仰角（通常为 0）
  "roll": 0.0      // 翻滚角（通常为 0）
}
```

## 🧪 测试步骤

### 方式一：快速测试 API（终端）

#### 1. 运行 API 测试脚本

```bash
cd /home/han14/gitw/AOAathelta
python3 test_robot_pose.py
```

**预期输出：**
```
============================================================
测试小车位置 API
============================================================
时间: 2026-01-28 10:30:45
API 地址: http://192.168.11.1:1448/api/core/slam/v1/localization/pose
------------------------------------------------------------
HTTP 状态码: 200

✓ 成功获取数据!

响应数据:
{
  "x": 5.234,
  "y": 3.456,
  "yaw": 0.785,
  ...
}

字段检查:
  ✓ x: 5.234
  ✓ y: 3.456
  ✓ yaw: 0.785

小车状态:
  位置 X: 5.234 m
  位置 Y: 3.456 m
  朝向角: 0.785 rad
```

#### 2. 使用 curl 命令测试

```bash
curl -H "Secret: 123456" \
  http://192.168.11.1:1448/api/core/slam/v1/localization/pose
```

### 方式二：在 Web UI 中测试

#### 1. 启动应用

```bash
cd /home/han14/gitw/AOAathelta
python3 web_app.py
```

#### 2. 打开浏览器

访问 http://127.0.0.1:5000

#### 3. 加载地图

点击 **📍 加载地图** 按钮，地图将显示在画布中

#### 4. 启动系统

点击 **▶️ 启动** 按钮，系统开始接收实时数据

#### 5. 观察小车位置

- **地图中的蓝色箭头** 表示小车位置
  - 箭头的**位置**表示小车的坐标 (x, y)
  - 箭头的**方向**表示小车的朝向角 (yaw)

- **右下方信息面板** 显示详细数据：
  ```
  🤖 机器人信息
  位置 X: 5.23 m
  位置 Y: 3.45 m
  朝向: 0.785 rad
  连接状态: ✓ 在线
  ```

## 📊 Web UI API 端点

### 获取小车位置和朝向

```
GET /api/robot-pose
```

**响应示例：**
```json
{
  "x": 5.234,
  "y": 3.456,
  "yaw": 0.785,
  "z": 0.0,
  "pitch": 0.0,
  "roll": 0.0
}
```

## 🎨 可视化说明

### 小车箭头样式

```
┌──────────────────────────────────────────┐
│                                          │
│          地图显示区域                     │
│                                          │
│              ▲  ← 朝向方向                │
│              │                           │
│    ━━━━━━━━━━●━━━━━━━━━━  ← 小车位置     │
│              │      \                    │
│              │       \ (箭头方向表示朝向) │
│              ▼                           │
│         (蓝色箭头)                        │
│                                          │
└──────────────────────────────────────────┘
```

### 颜色编码

| 颜色 | 含义 |
|------|------|
| 🔵 **蓝色** | 小车（机器人） |
| 🔴 **红色** | Beacon（信标） |
| 🟡 **黄色** | 警戒区域 |
| ⬜ **白色** | 小车中心点 |

## ⚙️ 配置调整

### 修改 API 地址

编辑 `web_app.py`，找到 `update_position_worker()` 函数，修改 API URL：

```python
# 修改此处
robot_pose = api_client.fetch_pose()
# api_client 从 core/api_client.py 中初始化，
# 其基础 URL 在 config.py 中配置
```

更好的方式是编辑 `config.py`：

```python
# config.py
API_BASE_URL = "http://192.168.11.1:1448"  # 修改此 IP 地址
```

### 修改箭头大小

编辑 `static/js/map.js`，在 `drawRobot()` 方法中修改：

```javascript
const arrowSize = 20;  // 修改此值（单位：像素）
// 数值越大，箭头越长
```

### 修改箭头颜色

编辑 `static/js/map.js`，在 `drawRobot()` 方法中修改：

```javascript
// 修改下列颜色值
this.ctx.fillStyle = '#0096ff';  // 蓝色（改成其他颜色代码）
```

常用颜色代码：
- `#ff0000` - 红色
- `#00ff00` - 绿色
- `#0000ff` - 蓝色
- `#ffff00` - 黄色
- `#ff00ff` - 紫色

## 🐛 故障排除

| 问题 | 原因 | 解决方案 |
|------|------|--------|
| ❌ 小车不显示 | 地图未加载 | 先点击"加载地图" |
| ❌ 小车位置固定不动 | API 无法访问 | 运行 `test_robot_pose.py` 检查 |
| ❌ 箭头方向不正确 | 坐标系转换错误 | 检查 yaw 值范围（应该是弧度 -π 到 π） |
| ❌ 显示"连接状态: -" | API 返回错误 | 检查 API 返回的 HTTP 状态码 |
| ❌ 小车标签显示位置错误 | Canvas 坐标计算错误 | 检查地图坐标系是否正确加载 |

### 快速诊断

运行诊断脚本：

```bash
python3 check_env.py
python3 test_robot_pose.py
```

查看浏览器开发者工具（F12）的 Console 标签，查找错误消息。

## 📈 实时监测

启动应用后，小车位置会以 **10 Hz 频率**实时更新：

```
时间线：
0.0s  │ 启动系统
      │
0.1s  │ ✓ 收到第 1 个位置数据
      │
0.2s  │ ✓ 收到第 2 个位置数据
      │
0.3s  │ ✓ 收到第 3 个位置数据
      │
...   │ 持续更新
```

## 🎯 应用场景

### 场景 1：实时监控小车运动

1. 加载地图
2. 启动系统
3. 观察蓝色箭头在地图上的运动
4. 箭头方向指示小车当前朝向

### 场景 2：与 Beacon 位置对照

1. 同时启动 Beacon 和小车位置显示
2. 观察：
   - 红色圆点（Beacon）= 信标位置
   - 蓝色箭头（Robot）= 小车位置
3. 对照两个位置是否符合实际

### 场景 3：与警戒区域结合

1. 绘制警戒区域（黄色矩形）
2. 启动系统，观察小车运动
3. 小车进入区域时是否有告警（当前仅支持 Beacon）

## 📝 代码修改记录

### 修改的文件

1. **`static/js/map.js`**
   - 添加 `robotYaw` 属性
   - 修改 `drawRobot()` 方法以绘制箭头
   - 修改 `updateRobot()` 方法以接收 yaw 参数
   - 在数据更新函数中传递 yaw 值

2. **`test_robot_pose.py`** (新增)
   - API 连接测试脚本

### 新增方法

- `MapViewer.updateRobot(x, y, yaw)` - 更新小车位置和朝向
- `MapViewer.drawRobot()` - 绘制小车箭头

## 🚀 性能提示

- 小车位置更新频率：**10 Hz**（每 100ms 更新一次）
- API 查询频率：**20 Hz**（地盘可能返回的频率）
- Canvas 重绘：仅当数据变化时才重绘

## 📚 相关文档

- [Web UI 快速开始](WEB_UI_QUICKSTART.md)
- [完整使用手册](WEB_UI_GUIDE.md)
- [系统架构](ARCHITECTURE.md)

---

**最后更新：** 2026-01-28  
**功能状态：** ✅ 已实现并测试

祝你测试顺利！🎉
